# Подключение компонентов - Pac-Man на STM32F401

## Обзор системы

Проект представляет собой полноценную игру Pac-Man, реализованную на микроконтроллере STM32F401CDU6 с использованием TFT дисплея ILI9341 и джойстика KY-023.

## Основные компоненты

### 1. Микроконтроллер STM32F401CDU6

**Характеристики:**
- Ядро: ARM Cortex-M4
- Тактовая частота: 84 MHz (настроена в проекте)
- Flash: 384 KB
- RAM: 96 KB
- Пакет: UFQFPN48

**Используемые периферийные модули:**
- SPI1 - для связи с TFT дисплеем
- ADC1 - для чтения джойстика
- GPIO - для управления дисплеем и чтения кнопок

### 2. TFT Дисплей ILI9341

**Характеристики:**
- Разрешение: 240x320 пикселей
- Интерфейс: SPI
- Цветовая глубина: 16-bit (RGB565)
- Размер: 2.8" (типично)

**Подключение к STM32F401:**

| Сигнал ILI9341 | Пин STM32 | Описание |
|----------------|----------|----------|
| VCC | 3.3V | Питание |
| GND | GND | Земля |
| CS | PA4 | Chip Select (активный LOW) |
| RESET | PA3 | Reset (активный LOW) |
| DC/RS | PA2 | Data/Command (HIGH=данные, LOW=команда) |
| MOSI | PA7 | SPI Master Out Slave In |
| SCK | PA5 | SPI Clock |
| LED | 3.3V (через резистор) | Подсветка (опционально) |

**Настройка SPI:**
- Режим: Master
- Скорость: APB2/2 (высокая скорость для быстрой отрисовки)
- Размер данных: 8-bit
- Полярность: CPOL=0, CPHA=1 (SPI Mode 0)

**Ориентация дисплея:**
- По умолчанию: VERTICAL (240x320)
- Можно изменить на HORIZONTAL в `ili9341_spi.h`

### 3. Джойстик KY-023

**Характеристики:**
- Тип: Аналоговый джойстик с двумя осями
- Разрешение ADC: 12-bit (0-4095)
- Кнопка: Цифровая (активный LOW)

**Подключение к STM32F401:**

| Сигнал KY-023 | Пин STM32 | Описание |
|---------------|----------|----------|
| VCC | 3.3V или 5V | Питание (проверьте документацию вашего джойстика) |
| GND | GND | Земля |
| VRx | PA0 | X-ось (ADC1_IN0) |
| VRy | PA1 | Y-ось (ADC1_IN1) |
| SW | PA6 | Кнопка (GPIO Input с подтяжкой вверх) |

**Настройка ADC:**
- Разрешение: 12-bit
- Время выборки: 3 цикла (быстрое чтение)
- Режим: Single conversion (последовательное чтение каналов)

**Пороги чувствительности:**
```c
#define JOYSTICK_CENTER_MIN 1500   // Минимальное значение центра
#define JOYSTICK_CENTER_MAX 2600   // Максимальное значение центра
#define JOYSTICK_THRESHOLD 800     // Зона нечувствительности
```

**Калибровка:**
- Центральное положение: ~2048 (середина 12-bit диапазона)
- При отклонении джойстика за пороговые значения определяется направление
- Мертвая зона предотвращает случайные движения

### 4. Дополнительные кнопки (опционально)

**Кнопка START:**
- Пин: PA8
- Режим: GPIO Input с подтяжкой вверх
- Назначение: Запуск игры, пропуск анимаций
- Альтернатива: Можно использовать кнопку джойстика (SW)

## Схема подключения

```
                    STM32F401CDU6
                    ┌─────────────┐
                    │             │
     ILI9341        │             │
    ┌────────┐      │             │
    │ VCC    ├──────┤ 3.3V        │
    │ GND    ├──────┤ GND         │
    │ CS     ├──────┤ PA4         │
    │ RESET  ├──────┤ PA3         │
    │ DC     ├──────┤ PA2         │
    │ MOSI   ├──────┤ PA7 (SPI1)  │
    │ SCK    ├──────┤ PA5 (SPI1)  │
    └────────┘      │             │
                    │             │
     KY-023         │             │
    ┌────────┐      │             │
    │ VCC    ├──────┤ 3.3V/5V     │
    │ GND    ├──────┤ GND         │
    │ VRx    ├──────┤ PA0 (ADC1)  │
    │ VRy    ├──────┤ PA1 (ADC1)  │
    │ SW     ├──────┤ PA6 (GPIO)  │
    └────────┘      │             │
                    │             │
    START Button    │             │
    ┌────────┐      │             │
    │  ┌──┐  │      │             │
    │  └──┘  │      │             │
    │   │    ├──────┤ PA8 (GPIO)  │
    │  GND   ├──────┤ GND         │
    └────────┘      │             │
                    └─────────────┘
```

## Настройка питания

### Рекомендации по питанию:

1. **STM32F401:**
   - Напряжение: 3.3V
   - Ток: ~50-100mA в активном режиме
   - Рекомендуется стабилизатор с запасом по току

2. **ILI9341:**
   - Напряжение: 3.3V
   - Ток: ~50-150mA (зависит от подсветки)
   - Подсветка может требовать отдельного питания

3. **KY-023:**
   - Напряжение: 3.3V или 5V (зависит от модели)
   - Ток: <10mA
   - Проверьте документацию вашего джойстика

### Общие требования:
- Общий ток: ~200-300mA
- Стабилизатор: 3.3V, минимум 500mA
- Конденсаторы: 100nF на каждый чип, 10uF на вход питания

## Настройка пинов в коде

Все определения пинов находятся в `Core/Inc/main.h`:

```c
// LCD пины
#define LCD_DC_Pin GPIO_PIN_2
#define LCD_RES_Pin GPIO_PIN_3
#define LCD_CS_Pin GPIO_PIN_4

// Джойстик пины
#define JOYSTICK_X_Pin GPIO_PIN_0  // PA0 - ADC1_IN0
#define JOYSTICK_Y_Pin GPIO_PIN_1  // PA1 - ADC1_IN1
#define JOYSTICK_SW_Pin GPIO_PIN_6  // PA6 - Button

// Кнопка START
#define START_Pin GPIO_PIN_8
```

## Проверка подключения

### Тест дисплея:
1. При включении дисплей должен инициализироваться
2. Экран должен очиститься (черный цвет)
3. При запуске игры должен появиться титульный экран

### Тест джойстика:
1. В центре джойстика значения ADC должны быть ~1500-2600
2. При отклонении вверх/вниз - меняется Y
3. При отклонении влево/вправо - меняется X
4. Кнопка должна читаться как LOW при нажатии

### Тест кнопки START:
1. При нажатии GPIO должен читаться как LOW
2. Кнопка должна запускать игру на титульном экране

## Возможные проблемы и решения

### Дисплей не работает:
- Проверьте подключение SPI (MOSI, SCK)
- Проверьте CS, RESET, DC пины
- Убедитесь, что SPI настроен правильно
- Проверьте питание дисплея

### Джойстик не реагирует:
- Проверьте подключение VRx, VRy к ADC пинам
- Проверьте, что ADC инициализирован
- Откалибруйте пороги в коде
- Проверьте питание джойстика (3.3V или 5V)

### Кнопки не работают:
- Проверьте подключение к GPIO пинам
- Убедитесь, что подтяжка вверх включена
- Проверьте, что пины настроены как INPUT

## Альтернативные варианты подключения

Если нужны другие пины:
1. Измените определения в `main.h`
2. Обновите конфигурацию в `MX_GPIO_Init()` и `MX_ADC1_Init()`
3. Обновите MSP функции в `stm32f4xx_hal_msp.c`

## Дополнительные компоненты (опционально)

- **Звук:** Код для звука закомментирован, можно добавить PWM или DAC
- **Светодиоды:** Можно добавить индикацию состояния
- **Датчики:** Можно добавить дополнительные датчики через свободные пины


