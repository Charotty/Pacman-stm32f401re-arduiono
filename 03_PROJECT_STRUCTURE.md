# Структура проекта Pac-Man для STM32F401

## Общее описание

Проект представляет собой полноценную реализацию классической аркадной игры Pac-Man для микроконтроллера STM32F401CDU6. Игра отображается на TFT дисплее ILI9341 через SPI интерфейс и управляется джойстиком KY-023.

## Архитектура проекта

### Структура директорий:

```
PACMAN STM32 TFT ILI9341 SPI STM32F401/
├── Core/
│   ├── Inc/              # Заголовочные файлы
│   │   ├── main.h        # Основные определения и пины
│   │   ├── ili9341_spi.h # Драйвер дисплея
│   │   ├── image.h       # Графические данные игры
│   │   └── stm32f4xx_hal_conf.h  # Конфигурация HAL
│   ├── Src/              # Исходные файлы
│   │   ├── main.c        # Основная логика игры (2151 строка)
│   │   ├── ili9341_spi.c # Драйвер дисплея
│   │   └── stm32f4xx_hal_msp.c  # MSP функции
│   └── Startup/          # Startup код для STM32
├── Drivers/              # HAL драйверы STM32
│   ├── CMSIS/            # CMSIS библиотеки
│   └── STM32F4xx_HAL_Driver/  # HAL драйверы
├── Debug/                # Скомпилированные файлы
└── *.md                  # Документация
```

## Основные модули

### 1. main.c - Игровая логика

**Размер:** ~2151 строка кода

**Основные компоненты:**

#### Глобальные переменные:
- `_Character pacman, akabei, pinky, aosuke, guzuta` - Персонажи игры
- `_Music music` - Структура для музыки
- `unsigned char map[MAPXSIZE*MAPYSIZE]` - Виртуальная карта
- `unsigned char scenedata[]` - Данные карты (стены, еда)
- Массивы параметров уровней (скорости, таймеры)

#### Основные функции:

**Инициализация:**
- `gameinit()` - Инициализация всей игры (один раз)
- `gameinit2()` - Инициализация новой игры
- `gameinit3()` - Инициализация уровня
- `gameinit4()` - Инициализация позиций персонажей

**Управление:**
- `ReadJoystick()` - Чтение позиции джойстика через ADC
- `keycheck()` - Обработка ввода и изменение направления

**Движение:**
- `movepacman()` - Движение Pac-Man
- `movemonster()` - Универсальная функция движения монстра
- `moveakabei()`, `movepinky()`, `moveaosuke()`, `moveguzuta()` - AI каждого монстра
- `movechars()` - Движение всех персонажей

**Отображение:**
- `putpacman()` - Отрисовка Pac-Man с анимацией
- `putmonster()` - Отрисовка монстра
- `putmap()` - Отрисовка карты
- `displaychars()` - Отрисовка всех персонажей
- `erasechars()` - Стирание персонажей

**Игровая логика:**
- `huntedcheck()` - Проверка столкновений и поедания
- `fruitcheck()` - Логика появления фруктов
- `sound()` - Генерация звуковых эффектов
- `game()` - Главный игровой цикл
- `title()` - Титульный экран

**Анимации:**
- `deadanim()` - Анимация смерти Pac-Man
- `stageclear()` - Анимация прохождения уровня
- `coffeebreak1/2/3()` - Анимации между уровнями

### 2. ili9341_spi.c - Драйвер дисплея

**Функции низкого уровня:**
- `LCD_WriteComm()` - Отправка команды
- `LCD_WriteData()` - Отправка данных (1 байт)
- `LCD_WriteData2()` - Отправка данных (2 байта)
- `LCD_WriteDataN()` - Отправка данных (N байт)
- `LCD_Init()` - Инициализация дисплея

**Функции высокого уровня:**
- `LCD_Clear()` - Очистка экрана
- `LCD_SetCursor()` - Установка курсора
- `drawPixel()` - Рисование пикселя
- `putbmpmn()` - Вывод bitmap с прозрачностью
- `putfont()` - Вывод символа
- `printstr()` - Вывод строки
- `printnum()` - Вывод числа

**Графические примитивы:**
- `gline()` - Линия
- `hline()` - Горизонтальная линия
- `circle()` - Окружность
- `boxfill()` - Залитый прямоугольник

**Палитра:**
- `palette[256]` - Массив цветов (RGB565)
- `set_palette()` - Установка цвета в палитре

### 3. image.h - Графические данные

**Содержит:**
- `FontData[]` - Шрифт 8x8 пикселей (256 символов)
- `Pacmanbmp[][]` - Спрайты Pac-Man (13 вариантов)
- `Pacmandeadbmp[][]` - Анимация смерти (9 кадров)
- `Monsterbmp[][]` - Спрайты монстров (32 варианта: 4 монстра × 8 направлений)
- `Ijikebmp[][]` - Спрайты испуганных монстров (4 варианта)
- `Medamabmp[][]` - Спрайты "глаз" (4 направления)
- `Fruitbmp[][]` - Спрайты фруктов (8 типов)
- `Scorebmp[][]` - Спрайты очков (12 вариантов)
- `Bigpacbmp[][]` - Большой Pac-Man для анимаций (4 варианта)
- `Titlelogobmp[][]` - Логотип на титульном экране

**Формат данных:**
- Каждый спрайт - массив `unsigned char`
- Размеры: от 8x8 до 31x31 пикселей
- Цвета: индексы палитры (0 = прозрачный)

### 4. main.h - Определения и конфигурация

**Определения пинов:**
- Пины дисплея (LCD_DC, LCD_RES, LCD_CS)
- Пины джойстика (JOYSTICK_X, JOYSTICK_Y, JOYSTICK_SW)
- Пины кнопок (START)

**Игровые константы:**
- Размеры карты (MAPXSIZE, MAPYSIZE)
- Координаты специальных точек
- Таймеры и скорости
- Определения режимов монстров

**Структуры данных:**
- `_Character` - Структура персонажа
- `_Music` - Структура музыки

## Потоки данных

### Инициализация:

```
main()
  ├─> HAL_Init()
  ├─> SystemClock_Config()  // 84 MHz
  ├─> MX_GPIO_Init()        // Настройка GPIO
  ├─> MX_SPI1_Init()        // Настройка SPI
  ├─> MX_ADC1_Init()        // Настройка ADC
  ├─> init_graphic()        // Инициализация графики
  ├─> ReadJoystick()        // Калибровка джойстика
  └─> gameinit()            // Инициализация игры
```

### Игровой цикл (60 FPS):

```
while(gamestatus==1) {
    1. wait60thsec(1)        // Синхронизация
    2. sound()               // Звук
    3. erasechars()          // Стирание
    4. keycheck()            // Ввод → ReadJoystick() → ADC
    5. movechars()           // Физика
    6. displaychars()        // Отрисовка → SPI → Дисплей
    7. fruitcheck()          // Логика фруктов
    8. huntedcheck()         // Столкновения
    9. displayscore()        // Обновление счета
}
```

## Использование памяти

### RAM:

- **Глобальные переменные:** ~2-3 KB
  - Персонажи (5 × ~20 байт)
  - Карта (21×27 = 567 байт)
  - Палитра (256 × 2 байт = 512 байт)
  - Игровые переменные

- **Стек:** ~1-2 KB (зависит от глубины вызовов)

- **Итого:** ~5-6 KB из 96 KB доступных

### Flash:

- **Код:** ~50-70 KB
- **Графические данные:** ~30-40 KB
- **HAL библиотеки:** ~100-150 KB
- **Итого:** ~200-250 KB из 384 KB доступных

## Зависимости

### HAL (Hardware Abstraction Layer):

- `HAL_GPIO` - Управление GPIO
- `HAL_SPI` - SPI коммуникация
- `HAL_ADC` - Аналого-цифровое преобразование
- `HAL_DMA` - Прямой доступ к памяти (опционально)
- `HAL_CORTEX` - Системные функции

### CMSIS:

- Определения регистров STM32F4
- Системные функции

## Оптимизации

### Производительность:

1. **SPI оптимизация:**
   - Высокая скорость SPI (APB2/2)
   - Группировка данных в буферы
   - Минимизация количества транзакций

2. **Отрисовка:**
   - Частичное обновление экрана
   - Пропуск прозрачных пикселей
   - Использование палитры вместо прямых цветов

3. **ADC чтение:**
   - Последовательное чтение каналов
   - Минимальное время выборки
   - Можно оптимизировать через DMA

### Память:

- Графические данные хранятся в Flash (const)
- Использование статических буферов
- Минимизация динамических выделений

## Расширяемость

### Возможные улучшения:

1. **Звук:**
   - Добавить PWM или DAC для звука
   - Реализовать музыкальный движок

2. **Графика:**
   - Добавить больше анимаций
   - Улучшить спрайты
   - Добавить эффекты

3. **Игровая механика:**
   - Больше уровней
   - Дополнительные режимы игры
   - Сохранение рекордов в EEPROM

4. **Производительность:**
   - Использовать DMA для SPI
   - Использовать DMA для ADC
   - Оптимизировать алгоритмы отрисовки

## Портируемость

### Для портирования на другой микроконтроллер:

1. **Заменить HAL функции:**
   - SPI функции
   - GPIO функции
   - ADC функции
   - Таймеры/задержки

2. **Адаптировать пины:**
   - Изменить определения в `main.h`
   - Обновить инициализацию

3. **Адаптировать разрешение:**
   - Изменить X_RES, Y_RES
   - Масштабировать координаты

4. **Адаптировать частоту:**
   - Изменить `wait60thsec()` под новую частоту
   - Настроить таймеры

## Отладка

### Полезные точки отладки:

1. **Проверка инициализации:**
   - Дисплей должен очиститься
   - Джойстик должен читаться

2. **Проверка игрового цикла:**
   - `gamecount` должен увеличиваться
   - Персонажи должны двигаться

3. **Проверка столкновений:**
   - Логика в `huntedcheck()`
   - Проверка координат

### Инструменты:

- STM32CubeIDE для отладки
- Логирование через UART (можно добавить)
- Визуальная отладка на дисплее

## Лицензия и авторство

Проект основан на коде для PIC32MX, портированном на STM32F401.
Автор оригинального кода: Ismail (судя по надписи на титульном экране).

## Заключение

Проект представляет собой полноценную реализацию классической игры с:
- Полной игровой механикой
- Реалистичным AI монстров
- Плавной анимацией
- Оптимизированной отрисовкой
- Готовностью к расширению

Код хорошо структурирован и документирован, что облегчает понимание и модификацию.


