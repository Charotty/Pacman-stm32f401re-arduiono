# Алгоритмы и логика игры Pac-Man

## Обзор игровой механики

Игра реализует классическую механику Pac-Man с полной физикой движения, AI монстров, системой очков и несколькими уровнями.

## Игровой цикл

### Основная структура:

```
main()
  └─> title()          // Титульный экран
      └─> game()        // Основной игровой цикл
          └─> gameinit3()  // Инициализация уровня
              └─> while(gamestatus==1)  // Игровой цикл (60 FPS)
                  ├─> sound()          // Звуковые эффекты
                  ├─> erasechars()     // Стирание персонажей
                  ├─> keycheck()       // Обработка ввода
                  ├─> movechars()      // Движение персонажей
                  ├─> displaychars()   // Отрисовка персонажей
                  ├─> fruitcheck()     // Проверка фруктов
                  ├─> huntedcheck()    // Проверка столкновений
                  └─> displayscore()   // Обновление счета
```

### Состояния игры (gamestatus):

- **0** - Начало игры (показ вступительной анимации)
- **1** - Игра в процессе
- **2** - Pac-Man пойман (анимация смерти)
- **3** - Уровень пройден (анимация очистки)
- **4** - Игра окончена

## Система координат и движения

### Фиксированная точка:

Все координаты используют **фиксированную точку** с 8-битной дробной частью:
- Формат: `unsigned short` (16-bit)
- Старшие 8 бит: целая часть (в пикселях)
- Младшие 8 бит: дробная часть (субпиксели)

**Пример:**
```c
pacman.x = 10*8*256;  // Позиция 10.0 в координатах карты
// 10*8 = 80 пикселей
// *256 = добавление дробной части для плавности
```

### Карта:

- Размер: 21x27 ячеек (в координатах карты)
- Каждая ячейка: 8x8 пикселей
- Типы ячеек:
  - `MAP_NONE` (0) - Проход
  - `MAP_WALL` (1) - Стена
  - `MAP_COOKIE` (2) - Еда
  - `MAP_POWERCOOKIE` (3) - Энергетик
  - `MAP_FRUIT` (4) - Фрукт
  - `MAP_DOOR` (5) - Дверь (только для монстров)

### Движение Pac-Man:

**Алгоритм `movepacman()`:**

1. Проверка таймера охоты (если монстры пойманы - остановка)
2. Получение текущих координат
3. Проверка направления движения:
   - Проверка границ карты (телепортация)
   - Проверка столкновения со стеной
   - Движение с учетом скорости
4. Обновление координат

**Особенности:**
- Телепортация через края карты
- Дверь монстров блокирует движение вниз
- Движение возможно только на пересечениях (когда координата кратна 8)

### Обработка ввода (`keycheck()`):

1. Чтение позиции джойстика через ADC
2. Преобразование аналоговых значений в направления
3. Проверка возможности поворота (только на пересечениях)
4. Изменение направления при отсутствии стены

**Пороги джойстика:**
```c
KEYUP:    joystick_y < 700   (1500 - 800)
KEYDOWN:  joystick_y > 3400  (2600 + 800)
KEYLEFT:  joystick_x < 700
KEYRIGHT: joystick_x > 3400
```

## AI Монстров

### Структура монстра (_Character):

```c
typedef struct {
    unsigned short x, y;        // Координаты (фиксированная точка)
    unsigned short oldx, oldy;   // Предыдущие координаты
    unsigned short speed;        // Скорость движения
    unsigned char status;        // Режим (NAWABARI, OIKAKE, IJIKE, etc.)
    unsigned char dir;           // Направление (0-3: UP, RIGHT, DOWN, LEFT)
    unsigned char turn;          // Флаг поворота
    unsigned char animvalue;     // Значение анимации
    unsigned char animcount;     // Счетчик анимации
    unsigned short modecount;    // Счетчик режима
} _Character;
```

### Режимы монстров:

1. **NAWABARI** (Патрулирование):
   - Монстр движется к фиксированной точке на карте
   - Используется в начале уровня
   - Переключается на OIKAKE через таймер

2. **OIKAKE** (Преследование):
   - Монстр преследует Pac-Man
   - Каждый монстр имеет свою стратегию:
     - **Akabei (красный)**: Прямое преследование
     - **Pinky (розовый)**: Цель = позиция Pac-Man + 3 клетки вперед
     - **Aosuke (синий)**: Цель = симметричная точка относительно Akabei
     - **Guzuta (оранжевый)**: Преследует на расстоянии, иначе уходит в угол

3. **IJIKE** (Испуг):
   - Активируется при поедании энергетика
   - Монстр убегает от Pac-Man
   - Замедляется (скорость уменьшается)
   - Мигает белым перед окончанием эффекта

4. **MEDAMA** (Возврат домой):
   - После поимки монстр становится "глазом"
   - Движется к дому монстров
   - Быстрее обычного движения

5. **TAIKI / TAIKI2** (Ожидание в доме):
   - Монстр находится в доме
   - Выходит через определенное время

### Алгоритм движения монстра (`movemonster()`):

**Шаг 1: Проверка текущего движения**
- Если монстр повернул, продолжает движение до пересечения
- Если движется прямо, продолжает до следующего пересечения

**Шаг 2: Определение доступных направлений**
- Проверка всех 4 направлений на наличие стены
- Учет односторонних проходов
- Учет двери (для обычных монстров)

**Шаг 3: Выбор направления по приоритету**
- Приоритет зависит от текущего направления
- Пример для DIR_UP: право → вверх → влево
- Выбирается первое доступное направление к цели

**Шаг 4: Движение**
- Обновление координат
- Замедление в зоне телепортации (для обычных монстров)

### Уникальные стратегии монстров:

**Pinky (розовый) - "Machibuse" (Засада):**
```c
// Цель = позиция Pac-Man + 3 клетки в направлении движения
if(pacman.dir==DIR_UP)
    targety = pacman.y - 3*8*256;  // На 3 клетки впереди
```

**Aosuke (синий) - "Kimagure" (Капризный):**
```c
// Цель = симметричная точка относительно Akabei
targetx = pacman.x/2 - akabei.x/4;
targety = pacman.y/2 - akabei.y/4;
```

**Guzuta (оранжевый) - "Otoboke" (Ленивый):**
```c
// Если далеко от Pac-Man - преследует
// Если близко - уходит в угол
if(dx*dx+dy*dy > 10) {
    target = pacman;  // Преследование
} else {
    target = corner;  // Уход в угол
}
```

## Система столкновений

### Проверка столкновения (`huntedcheck()`):

**Алгоритм:**

1. **Проверка поедания еды:**
   - Когда Pac-Man на пересечении (координата кратна 8)
   - Проверка типа ячейки карты
   - Обычная еда: +1 очко
   - Энергетик: +5 очков, активация режима IJIKE для всех монстров

2. **Проверка поедания фрукта:**
   - Фрукт появляется при определенном количестве оставшейся еды
   - Появляется дважды за уровень
   - Дает бонусные очки (10-500 в зависимости от уровня)

3. **Проверка столкновения с монстрами:**
   - Проверка перекрытия координат (порог = 7 пикселей)
   - Если монстр в режиме IJIKE - Pac-Man его съедает
   - Если монстр в обычном режиме - Pac-Man пойман

4. **Проверка очистки уровня:**
   - Когда вся еда съедена - уровень пройден

### Подсчет очков за монстров:

```c
// Первый монстр: 200 очков
// Второй: 400 очков
// Третий: 800 очков
// Четвертый: 1600 очков
score += (1 << huntedmonster) * 10;
```

## Система фруктов

### Появление фруктов:

- **Первый фрукт:** Когда осталось 130 еды
- **Второй фрукт:** Когда осталось 55 еды
- Время отображения: 600 кадров (10 секунд)

### Типы фруктов по уровням:

```c
unsigned char fruit[] = {0,1,2,2,3,3,4,4,5,5,6,6,7};
// 0: Вишня (10 очков)
// 1: Клубника (30 очков)
// 2: Апельсин (50 очков)
// 3: Яблоко (70 очков)
// 4: Дыня (100 очков)
// 5: Колокол (200 очков)
// 6: Ключ (300 очков)
// 7: Галактический босс (500 очков)
```

## Система уровней

### Параметры уровней:

Каждый уровень имеет свои параметры скорости:

```c
// Скорость Pac-Man по уровням
unsigned short pacmansp[] = {135,150,150,150,160,160,160,170,...};

// Скорость монстров
unsigned short monstersp[] = {135,150,150,150,160,160,160,170,...};

// Скорость испуганных монстров
unsigned short ijikesp[] = {50,60,60,60,65,65,65,70,...};

// Время действия энергетика
unsigned short ijike[] = {550,520,450,350,130,300,130,120,...};
```

### Прогрессия сложности:

- Уровни 1-21: Уникальные параметры
- Уровни 22+: Повторение параметров 21-го уровня
- Скорость увеличивается с каждым уровнем
- Время действия энергетика уменьшается

## Система анимации

### Анимация Pac-Man:

- 6 кадров на направление (закрытый рот + 5 фаз открытия)
- Счетчик анимации: 5 кадров на фазу
- Циклическое переключение

### Анимация монстров:

- 2 кадра для ног (переключение каждые 4 кадра)
- Разные спрайты для каждого направления
- Мигание при окончании режима IJIKE

### Анимация энергетика:

- Мигание каждые 16 кадров
- Изменение палитры цвета

## Система звука

### Реализация:

Звук реализован через программную генерацию (код закомментирован):
- Звуки монстров (разные в разных режимах)
- Звук поедания еды
- Звук поедания фрукта
- Звук поимки монстра
- Фоновая музыка

### Приоритет звуков:

1. Звук поимки монстра
2. Звук фрукта
3. Звук еды
4. Звук монстров
5. Музыка

## Coffee Break (Между уровнями)

Специальные анимации между определенными уровнями:
- Уровень 2: Первая анимация
- Уровень 5: Вторая анимация (с булавкой)
- Уровни 9, 13, 17: Третья анимация (голый монстр)

## Оптимизации производительности

### Отрисовка:

1. **Частичное обновление:**
   - Стираются только измененные области
   - Перерисовываются только персонажи

2. **Прозрачность:**
   - Цвет 0 = прозрачный
   - Пропускаются прозрачные пиксели

3. **Буферизация:**
   - Используется буфер для группировки пикселей
   - Минимизируется количество SPI транзакций

### Тайминг:

- Игровой цикл: 60 FPS (1/60 секунды на кадр)
- Все анимации синхронизированы с этим таймером
- Используется функция `wait60thsec()` для точной синхронизации

## Особенности реализации

### Физика движения:

- Движение возможно только на пересечениях (координата кратна 8)
- Это предотвращает "застревание" в стенах
- Позволяет плавное изменение направления

### AI монстров:

- Монстры не могут поворачивать на 180° сразу
- Должны пройти до следующего пересечения
- Это создает реалистичное поведение

### Система координат:

- Использование фиксированной точки позволяет плавное движение
- Субпиксельная точность для разных скоростей
- Легко масштабируется для разных разрешений


